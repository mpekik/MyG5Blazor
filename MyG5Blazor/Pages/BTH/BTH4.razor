@page "/bth/4"

@using MyG5Blazor.Data
@using System.IO.Ports
@using System.Threading
@using System.Text
@using System 
 
@inject IJSRuntime JSRuntime
@inject Costumer cst
@inject NavigationManager NavMan  
@inject EDC edc 

<div class=@pageClass>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
            <div class="navbar-wrapper">
                <div class="logo">
                    <img src="../../assets/image/Logo/Logo_MyGraPARI.png" />
                </div>
                <!-- <a class="navbar-brand" href="javascript:;">Dashboard</a> -->
            </div>

            <form class="col-md-6">
                <div class="input-group no-border">
                    <div class="checklist">
                        @if (IsLoading)
                        {
                            <img src="../../assets/image/loader.gif" />
                        }
                        else if (IsSuccess)
                        {
                            <img src="../../assets/image/tanda_checklist.png" />
                        }
                        else if (IsFail)
                        {
                            <img src="../../assets/image/tanda_x.png" />
                        }
                    </div>
                </div>
            </form>
        </div>
    </nav>
    <!-- End Navbar -->

    <div class="content">
        <div class="container-fluid">
            <div class="row">
                @switch (MetodePembayaran)
                {
                    case 1:
                        {
                            @if (!IsFail && !IsSuccess)
                            {
                                <div id="credit-payment" class="modal-blank-1" style="background-image: url(../image/bg-02.jpg); background-size: cover; background-position: center center;background-attachment: fixed; ">
                                    <img src="../../assets/image/debit.png" class="img-debit" id="myBtn">
                                    <div class="modal-blank-text">
                                        <div class="text1" id="teks-temukan">Temukan mesin EDC pada <br> MyGraPARI seperti gambar di atas</div>
                                        <div class="text2">Gesek Kartu Debit Anda dengan <br> bagian pita hitam menghadap ke <br> arah mesin EDC</div>
                                        <div class="text3">Masukkan PIN dan tekan OK <br> <p class="green">(tombol hijau)</p></div>
                                    </div>
                                </div>
                            }
                            else if (IsSuccess)
                            {
                                <div class="col-md-6">
                                    <div class="teks-title">Bayar Tagihan KartuHalo</div>
                                    <div id="status-pay" class="teks-center teks-bold">Proses Pembayaran Tagihan KartuHalo<br> <b class="green">Berhasil</b></div>
                                </div>

                                <div class="col-md-6">
                                    <div id="image-pulsa" class="image-center2">
                                        <img src="../../assets/image/Logo/pulsa-prabayar.png" alt="" width="450px" height="280px">
                                    </div>
                                </div>
                            }
                            else if (IsFail)
                            {
                                <div class="col-md-6">
                                    <div class="teks-title">Bayar Tagihan KartuHalo</div>
                                    <div id="status-pay" class="teks-center teks-bold">
                                        Proses Pembayaran Tagihan KartuHalo<br> <b class="red">FAILED</b><br><br>
                                        @if (IsVoid)
                                        {
                                           <span style = "font-weight: normal;">Silahkan <span style = "font-weight: bold;" > Tekan ENTER(Tombol Hijau)</span>pada Mesin EDC untuk Proses Pengembalian Uang </span>
                                        }
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div id="image-pulsa" class="image-center2">
                                        <img src="../../assets/image/Logo/pulsa-prabayar.png" alt="" width="450px" height="280px">
                                    </div>
                                </div>
                            }
                            break;
                        }
                    case 2:
                        {
                            <div class="col-md-6">
                                @if (!IsFail && !IsSuccess)
                                {
                                    <div class="teks-title">Bayar Tagihan KartuHalo</div>
                                    <div id="teks-silakan">
                                        <div class="teks-top"> Silakan Masukan Uang Kertas pada Alat Penerima Uang Tunai secara Lembar per Lembar </div>
                                    </div>
                                    <div id="teks-pastikan">
                                        <div class="teks-center" style="margin-top: 32%;"> Pastikan Pembayaran Menggunakan <br> Uang Kertas Minimal Pecahan Rp 10.000 </div>
                                    </div>
                                    <div id="bayar2">
                                        <div class="teks-bot" style="text-transform: uppercase; font-weight: bold; margin-top: 49%; line-height: 1;">Bayar Dengan Uang Pas, Mesin <br> Ini tidak mengeluarkan kembalian</div>
                                    </div>
                                    <div id="bayar3">
                                        <div class="teks-bot2" style="text-transform: uppercase; font-weight: bold; margin-top: 70%;">NILAI DARI KELEBIHAN PEMBAYARAN SECARA OTOMATIS AKAN MENGURANGI TAGIHAN KARTUHALO ANDA DI BULAN BERIKUTNYA.</div>
                                    </div>
                                }
                                @if (IsVisible2)
                                {
                                    <div id="teks-sudah-sesuai">
                                        <div class="teks-center" style="margin-top: 38%;"> Uang yang Anda Masukkan Sudah Sesuai dengan Jumlah yang Harus Dibayarkan </div>
                                    </div>
                                }

                                @if (IsFail)
                                {
                                    <div id="status-pay" class="teks-status2">Proses Pembayaran Tagihan KartuHalo <br><b class="red">Tidak Berhasil</b></div>
                                    <div id="nominal-pay" class="teks-center"> Silakan Ambil Struk Transaksi dan <br> Hubungi Kasir GraPARI untuk Bantuan</div>
                                }
                            </div>

                            <div class="col-md-6" id="proses-bill">
                                @if (!IsFail && !IsSuccess)
                                {
                                    <div id="">
                                        <img class="tunai" onclick="buttonNext()" id="" src="../../assets/image/tunai.png">
                                    </div>
                                    <div>
                                        <div class="jumlah-bayar">Jumlah yang Harus Dibayar</div>
                                        <div class="nominal-rupiah">Rp @intBill.ToString("N0")</div>
                                    </div><br>

                                    <div id="">
                                        <div class="jumlah-bayar">Uang yang telah Anda Masukan</div>
                                        @if (intAccBill < intBill)
                                        {
                                            <div class="nominal-rupiah" id="nominal-kurang">Rp @intAccBill.ToString("N0")</div>
                                        }
                                        else
                                        {
                                            <div class="nominal-rupiah" id="nominal-pas">Rp @intAccBill.ToString("N0")</div>
                                        }
                                    </div><br>
                                }
                                else
                                {
                                    <div id="image-pulsa" class="image-center2">
                                        <img src="../../assets/image/Logo/pulsa-prabayar.png" alt="" width="450px" height="280px">
                                    </div>
                                }
                            </div>
                            break;
                        }
                    case 3:
                        {
                            <div id="credit-payment" class="modal-blank-2">
                                <img src="../../assets/image/credit.png" alt="" width="100%" height="380px" style="padding-top:70px;" id="myBtn">
                                <div class="modal-blank-text">
                                    <div class="text-1">Temukan mesin EDC pada <br> MyGraPARI seperti gambar di atas</div>
                                    <div class="text-2">Masukkan Kartu Kredit Anda<br> melalui bagian bawah mesin<br> EDC dengan bagian Chip terlebih <br> dahulu</div>
                                    <div class="text-3">Masukkan PIN dan tekan OK <br> <b class="green">(tombol hijau)</b></div>
                                    <div class="text-4">Cabut Kartu Kredit Anda dari <br> Mesin EDC</div>
                                </div>
                            </div>
                            break;
                        }
                }
            </div>
        </div>
    </div>


    <footer>
        <div class="footer-side1">
            <span class="dot">1</span>
            <span class="dot">2</span>
            <span class="dot">3</span>
            <span class="dot" id="dot-active">4</span>
        </div>
        <div class="footer-side2">
            @if (MetodePembayaran == 2&&!IsFail&&!IsSuccess)
            {
            <button @onclick="@(()=>IsExit = true)" class="btn-arrow btn" value="">Kembali</button>
            <button @onclick="@(()=>IsExit = true)" class="btn-arrow btn" value="">Menu Utama</button>
            }
            <!--<sup>Powered By </sup>Trilogi Persada -->
        </div>
    </footer>
</div>
@if (IsExit)
{
<div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <p class="text-body">Anda belum menyelesaikan proses pembayaran<br>pulsa prabayar. Jika Anda keluar dari menu ini,<br>seluruh uang yang Anda masukkan dapat diambil di<br>Kasir GraPARI dengan menunjukkan struk dari<br>MyGraPARI.</p>
                <button class="btn btn-danger modal-button" @onclick="TunaiExitFail" id="btn-lanjut">Lanjut</button>
                <button @onclick="@(()=>IsExit = false)" class="btn btn-light modal-button">Batal</button>
            </div>
        </div>
    </div>
</div>
<!-- end modal -->
}
@if (IsVisible)
{
    <!-- The Modal -->
    <div id="myModal" class="modal">
        <div class="modal-dialog-centered" role="document">
            <div class="modal-nps">
                <!-- <div class="modal-header">
                  <span class="close">&times;</span>
                </div> -->
                <div class="modal-body">
                    <p class="text-header">Beri Penilaian Layanan MyGrapari</p>
                    <p class="text-nps">Seberapa besar kemungkinan Anda untuk merekomendasikan layanan MyGraPARI kepada teman atau kolega Anda? </p>
                    <button class="btn nps-button" value="1" @onclick="@(() => strNPS1Value = "1")">1</button>
                    <button class="btn nps-button" value="2" @onclick="@(() => strNPS1Value = "2")">2</button>
                    <button class="btn nps-button" value="3" @onclick="@(() => strNPS1Value = "3")">3</button>
                    <button class="btn nps-button" value="4" @onclick="@(() => strNPS1Value = "4")">4</button>
                    <button class="btn nps-button" value="5" @onclick="@(() => strNPS1Value = "5")">5</button>
                    <button class="btn nps-button" value="6" @onclick="@(() => strNPS1Value = "6")">6</button>
                    <button class="btn nps-button" value="7" @onclick="@(() => strNPS1Value = "7")">7</button>
                    <button class="btn nps-button" value="8" @onclick="@(() => strNPS1Value = "8")">8</button>
                    <button class="btn nps-button" value="9" @onclick="@(() => strNPS1Value = "9")">9</button>
                    <button class="btn nps-button" value="10" @onclick="@(() => strNPS1Value = "10")">10</button>
                    <button @onclick="CheckNPS" class="btn btn-danger button-nps">OK</button>
                    <!-- <button class="btn btn-light modal-button">Tidak</button> -->
                </div>
            </div>
        </div>
    </div>
}

@if (IsVisible2)
{
    <!-- The Modal -->
    <div id="myModal" class="modal">
        <div class="modal-dialog-centered" role="document">
            <div class="modal-nps">
                <!-- <div class="modal-header">
                  <span class="close">&times;</span>
                </div> -->
                <div class="modal-body">
                    <p class="text-header">Beri Penilaian Layanan MyGrapari</p>
                    <p class="text-nps">Hal apa yang Anda rasa perlu ditingkatkan pada mesin layanan MyGraPARI? </p>
                    <button class="btn nps-button2" value="">Tampilan/Estetika</button>
                    <button class="btn nps-button2" value="">Kecepatan Proses</button>
                    <button class="btn nps-button2" value="">Kemudahan Penggunaan</button>
                    <button class="btn nps-button2" value="">Kejelasan Bahasa</button>
                    <button @onclick="@(()=>NavMan.NavigateTo(""))" class="btn btn-danger button-nps" value="">OK</button>
                </div>
            </div>
        </div>
    </div>
}
@code
{
    private string pageClass = "main-panel bg-edc-process";
    private bool IsVisible = false;
    private bool IsVisible2 = false;
    private bool IsLoading = false;
    private bool IsSuccess = false;
    private bool IsFail = false;
    private bool IsExit = false;
    private bool IsVoid = false;
    private bool IsVoided = false;

    private int intTryCount = 1;
    private int intTryLimit = 3;
    private int MetodePembayaran = 0;

    private string strNPS1Value = string.Empty;

    private int intBill = 0;
    private int intAccBill = 0;
    private int intMinus = 0;

    private string strBill => intBill.ToString();
    private string strAccBill => intAccBill.ToString();
    private string strMinus => intMinus.ToString();
    private string strInvoice = "1";
    private string strBilling = "2";
    private string strCOM = "COM11";

    protected override async Task OnInitializedAsync()
    {
        MetodePembayaran = cst.intMPembayaran;
        intBill = cst.intTagihan;
        intAccBill = 10000;
        intMinus = intBill - intAccBill;
        switch (MetodePembayaran)
        {
            case 1:
                {
                    pageClass = "main-panel bg-edc-process";

                    //TODO Integrate with EDC Debit Card
                    await Pay(strCOM, strBill, strInvoice, strBilling, MetodePembayaran.ToString());
                    pageClass = "main-panel bg-home";
                    if (edc.intTry < 3)
                    {
                        Console.WriteLine("Trace Number : " + edc.traceNumber);
                        //ToDO Add if Void
                        IsVoid = true;
                        strInvoice = edc.traceNumber;
                        Void();
                        break;
                        IsSuccess = true;
                        Console.WriteLine("Payment Success");
                        await Task.Delay(2000);
                        IsVisible = true;
                    }
                    else
                    {
                        IsFail = true;
                        Console.WriteLine("Payment Failed");
                    }
                    break;
                }
            case 2:
                {
                    pageClass = "main-panel bg-home";
                    //TODO Integrate with Bill Acceptor
                    //CountMoneyBillAcceptor();
                    break;
                }
            case 3:
                {
                    pageClass = "main-panel bg-edc-process";

                    //TODO Integrate with EDC Credit Card
                    await Pay(strCOM, strBill, strInvoice, strBilling, MetodePembayaran.ToString());
                    pageClass = "main-panel bg-home";
                    if (edc.intTry < 3)
                    {
                        Console.WriteLine("Trace Number : " + edc.traceNumber);
                        IsSuccess = true;
                        Console.WriteLine("Payment Success");
                        await Task.Delay(2000);
                        IsVisible = true;
                    }
                    else
                    {
                        IsFail = true;
                        Console.WriteLine("Payment Failed");
                    }
                    break;
                }
        }
    }
    private void TunaiExitFail()
    {
        IsExit = false;
        IsFail = true;
    }
    private void CountMoneyBillAcceptor()
    {
        while (intAccBill < intBill)
        {
            //TODO Integrate with Bill Acceptor
        }
    }

    private async Task Void()
    {
        if (IsVoid)
        {
            IsFail = true;
            await Void(strCOM, strBill, strInvoice, strBilling, MetodePembayaran.ToString());
        }
    }

    private void CheckPerso()
    {
        if (!IsLoading && !IsSuccess && !IsFail && !IsVisible)
        {
            IsLoading = true;
        }
        else if (IsLoading && !IsSuccess)
        {
            IsLoading = false;
            if (intTryCount <= intTryLimit)
                intTryCount += 1;
            else
                IsFail = true;
        }
    }

    private void CheckNPS()
    {
        if (!IsVisible)
        {
            IsVisible = true;
        }
        else
        {
            strNPS1Value = string.Empty;
            IsVisible = false;
            IsVisible2 = true;
        }
    }

    private async Task Pay(string serialPortName,string tagihan,string invoice, string billing, string mPemabayaran)
    {
        string _transType = "01";
        edc.Clear();
        edc.serialPort = new SerialPort();
        edc.serialPort.PortName = serialPortName;
        edc.serialPort.DataReceived += new SerialDataReceivedEventHandler(edc.port_DataReceived);
        do
        {
            await Task.Delay(5000);
            if (edc.respondCode == "00")
                break;
            edc.SendCommand(tagihan, edc.serialPort, _transType, invoice, billing, mPemabayaran);
            edc.mre.WaitOne();
        } while (edc.intTry<3);
    }

    private async Task Void(string serialPortName, string tagihan, string invoice, string billing, string mPemabayaran)
    {
        string _transType = "02";
        edc.Clear();
        edc.serialPort = new SerialPort();
        edc.serialPort.PortName = serialPortName;
        edc.serialPort.DataReceived += new SerialDataReceivedEventHandler(edc.port_DataReceived);
        do
        {
            await Task.Delay(5000);
            if (edc.respondCode == "00")
            {
                IsVoided = true;
                break;
            }
            edc.SendCommand(tagihan, edc.serialPort, _transType, invoice, billing, mPemabayaran);

            Console.WriteLine(edc.respondCode);
        } while (!edc.mre.WaitOne());
        await Task.Delay(10000);
        NavigateTo("");
    }

    private void NavigateTo(string strURL)
    {
        NavMan.NavigateTo(strURL);
    }
} 